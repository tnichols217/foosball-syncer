import { GoogleSpreadsheet } from 'google-spreadsheet';
import { JWT } from 'google-auth-library'
import dotenv from "dotenv"
import { UsersRowData, VerifiedInputs } from "./index/parsedRow"
import { PeoplePointBucket, PeoplePointData } from "./index/pointData"
let env = dotenv.config().parsed as any

const SPREADSHEET = "1ajVhu1WlCYArATAQM2suTGiz1PKv6PIXSUqJBT5e_hM"
const SUBMIT_PREINTERVAL = 60*1000 // 1 minute interval for validation
const SUBMIT_INTERVAL = 10*60*1000 // 10 minutes interval for validation

const serviceAccountAuth = new JWT({
    // env var values here are copied from service account credentials generated by google
    // see "Authentication" section in docs for more info
    email:  env.GOOGLE_SERVICE_ACCOUNT_EMAIL,
    key: env.GOOGLE_PRIVATE_KEY.replace(/\\n/g, '\n'),
    scopes: [
        'https://www.googleapis.com/auth/spreadsheets',
    ],
});

// const getPeople = (rows: ParsedRowData[]): string[] => {
//     let o = [] as string[]
//     for ( let row of rows ) {
//         if (o.indexOf(row.Submitter) < 0) {
//             o.push(row.Submitter)
//         }
//         if (o.indexOf(row.Opponent) < 0) {
//             o.push(row.Opponent)
//         }
//     }
//     return o.sort()
// }

// const springForceWeight = (point: pointData, distance: number): number => {
//     //TODO: calculates force exerted upon other points based on pointdata and distance
//     //!

//     return 0
// }

const doc = new GoogleSpreadsheet(SPREADSHEET, serviceAccountAuth);
doc.loadInfo().then(async () => {
    const sheet = doc.sheetsByIndex[0];
    const userRows = await sheet.getRows<UsersRowData>();
    const verifiedInputs = VerifiedInputs.fromUsersRowData(userRows.map(row => row.toObject() as UsersRowData))
    const pointData = verifiedInputs.rows.map(input => PeoplePointData.fromGame(input))
    // const people = getPeople(verifiedInputs)
    const bucketPairs = new PeoplePointBucket(pointData)

    // console.log(people);
    console.log(bucketPairs);
});
